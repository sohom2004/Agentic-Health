from langchain.agents import initialize_agent, Tool
from langchain.tools import StructuredTool
from langchain_google_genai import ChatGoogleGenerativeAI
from tools import store_content
import os
from dotenv import load_dotenv
from pydantic import BaseModel, Field

load_dotenv()

class StoreContentInput(BaseModel):
    report_id: str = Field(..., description="The report id as a string")
    patient_id: str = Field(..., description="The patient id as a string")
    report_date: str = Field(..., description="The report date as a string")
    confidence: float = Field(..., description="The confidence score as a float")

tools = [
    Tool(
        name="StoreContent",
        func=store_content,
        description="Stores input dict into ChromaDB with metadata. Returns metadata"
    )
]

def create_document_agent():
    llm = ChatGoogleGenerativeAI(model="gemini-2.5-flash", google_api_key=os.getenv("GOOGLE_API_KEY"))

    agent = initialize_agent(
        tools=tools,
        llm=llm,
        agent="zero-shot-react-description",
        verbose=True,
        handle_parsing_errors=True
    )

    return agent

if __name__ == "__main__":
    text = {
    "content": "Sample Written History and Physical Examination\nHistory and Physical Examination\nComments\nPatient Name:\nRogers, Pamela\nDate:\n6/2/04\nReferral Source:\nEmergency Department\nData Source:\nPatient\nChief Complaint & ID:\nMs. Rogers is a 56 ylo WF\nDefine the reason for the patient\'s visit as who has been\nhaving chest pains for the last week\nspecifically as possible.\nHistory of Present Iness\nThis is the first admission for this 56 year old woman;\nConvey the acute or chronic nature of the problem and\nwho states she was in her usual state of good health until\nestablish a\nchronology:\none week prior to admission.\nAt that time she noticed the\nabrupt onset (over a few seconds to\nminute) of chest pain\nonset\nwhich she describes as dull and aching in character.\nThe\ncharacter\npain began in the left para-sternal area and radiated up to\nlocation\nher neck\nThe first episode of pain one week ago occurred\nradiation\nwhen she was working in her garden in the middle of the\ncircumstances; exacerbating factors\nday:\nShe states she had been working for approximately 45\nminutes and began to feel tired before the onset of the pain.\nHer discomfort was accompanied by shortness of breath, but\nassociated symptoms\nno\nsweating, nausea, or vomiting:\nThe pain lasted\napproximately 5 to 10 minutes and resolved when she went\nduration\ninside and rested in a cool area_\nresolution; alleviating factors\nSince that initial pain one week ago she has had 2 additional\nDescribe the natural\nof her problem since its\nepisodes of pain, similar in quality and location to the first\nonset\nepisode_\nThree\nago she had a 15 minute episode of\npain while walking her dog, which resolved with rest.\nThis\nChange or new circumstances to the problem\nevening she had an episode of pain awaken her from sleep,\nNew duration\nlasting 30 minutes, which prompted her visit to the\nReason she come in for visit\nEmergency Department:\nAt no time has she attempted any\nWhat has patient tried for relief\nspecific measures to relieve her pain, other than rest:\nShe\ndescribes no other associated symptoms during these\nepisodes of pain, including dizziness, or palpitations.\nShe\nbecomes short of breath\nduring these\nRelevant positive and negative ROS for this complaint\nepisodes but describes no other exertional dyspnea,\northopnea, or paroxysmal nocturnal dyspnea_\nNo\nchange in the pain\nwith movement;\nno association with food,\nno GERD sx, no palpable\nShe has never been told she has heart problems, never had any\nReview of systems for the relevant organ system\nchest pains before, does not have claudication.\nShe was diagnosed with\nHTN 3 years ago,\nShe does not smoke nor does she have diabetes_\nRelevant risk factorlenvironmental conditions\nShe was diagnosed with hypertension 3 years ag0 and had a\nTAH with BSO 6 years ago.\nShe is not on hormone replacement\ntherapy:\nThere is a family\nhistory of premature CAD.\nShe does not know her cholesterol level\nPast Medical History\nSurgical\n1994:\nTotal abdominal hysterectomy and bilateral\nThis highly relevant, although it may seem like a\noophorectomy for uterine fibroids.\ntrivial detail at first\n1998:\nBunionectomy\nhistory\ndays\npain.\nMedical History\n1998:\nDiagnosed with hypertension and began on\nunknown medication.  Stopped after 6 months\nbecause of drowsiness_\n1990:\nDiagnosed with peptic ulcer disease\nwhich\nresolved after three months on cimetidine_\nShe\nAlways use generic names\ndescribes no\nhistory of cancer, lung disease\nor previous heart disease_\nAllergy:\nPenicillin; experienced rash and hives in 1985.\nAlways list the type of reported reaction\nSocial History _\nAlcohol use:\nor 2 beers each weekend; 1 glass of\nQuantity\nwine once\na week with dinner.\nTobacco use:\nNone_\nMedications:\nNo prescription or illegal drug use _\nOccasional OTC ibuprofen (Advil) for\nInclude over-the-counter drugs\nheadache (QOD):\nFamily History\nMother:\n79, alive and well.\nComment specifically on the presence or absence of\nFather:\n54, deceased, heart attack:\nNo brothers\ndiseases relevant to the chief complaint\nor sisters.\nThere is a positive family history of\nhypertension, but no diabetes, or cancer\nReview of_Systems\nHEENT:\nNo complaints of headache change in vision, nose or ear\nSeparate each ROS section for easy identification\nproblems, or sore throat:\nCadiovascular:\nSee HPI\nOK to refer to HPI if adequately covered there\nGastrointestinal:\nNo complaints of dysphagia, nausea, vomiting, or change in\nList positive and negative findings in brief, concise\nstool pattern, consistency, or color:\nShe complains of\nphrases or sentences\nepigastric pain, burning in quality, approximately twice a\nmonth, which she notices primarily at night:\nGenitourinary:\nNo complaints of dysuria, nocturia, polyuria, hematuria, or\nvaginal bleeding:\nMusculoskeletal:\nShe complains of lower back pain, aching in quality,\napproximately once every week after working in her garden:\nThis pain is usually relieved with Tylenol:\nShe complains of\nno other arthralgias, muscle aches, or pains_\nNeurological:\nShe complains of no weakness, numbness, or incoordination_\nPhysical Examination\nVital Signs:\nBlood Pressure 168/98, Pulse 90, Respirations 20,\nAlways list vital signs:\nCheck for orthostatic BPIP\nTemperature 37 degrees_\nchanges if it is relevant to the patient\'s complaint\nGeneral:\nMs. Rogers appears alert, oriented and cooperative_\nDescription may give very important clues as to the\nnature or\nseverity of the patients problem\nSkin:\nNormal in appearance; texture, and temperature\nComment on all organ systems\nHEENT:\nScalp normal:\nList\nspecific normal or pathological findings when\nrelevant to the patient\'s complaint\nPupils equally round, 4 mm, reactive to light and\naccommodation, sclera and conjunctiva normal.\nFundoscopic examination reveals normal vessels without\nhemorrhage_\nTympanic membranes and external auditory canals normal:\nNasal mucosa normal.\nOral pharynx is normal without erythema or exudate_\nTongue\nand gums are normal:\nNeck:\nEasily moveable without resistance, no abnormal adenopathy\nin the cervical or supraclavicular areas_\nTrachea is midline\nand thyroid gland is normal without masses.\nCarotid artery\nupstroke is normal bilaterally without bruits_\nJugular venous\npressure is measured as 8 cm with patient at 45 degrees_\nChest:\nLungs are clear to auscultation and percussion bilaterally\nThis patient needs a detailed cardiac examination\nexcept for crackles heard in the lung bases bilaterally:\nPMI\nis in the 5th inter-costal space at the mid clavicular line.\ngrade 2/6 systolic decrescendo murmur is heard best at the\nsecond right inter-costal space which radiates to the neck:\nA third heard sound is heard at the apex\nNo fourth heart\nsound or rub are heard.\nCystic changes are noted in the\nbreasts bilaterally but no masses or nipple discharge is\nSeen:\nAbdomen:\nThe abdomen is symmetrical without distention; bowel\nsounds are normal in quality and intensity in all areas; a\nbruit is heard in the right paraumbilical area.\nNo masses or\nsplenomegaly are noted; liver span is 8 cm by percussion\nprecise than saying 'no hepatomegaly'\nExtremities:\nNo cyanosis, clubbing, or edema are noted.\nPeripheral\npulses in the femoral, popliteal, anterior tibial, dorsalis pedis,\nbrachial, and radial areas are normal \nNodes:\nNo palpable nodes in the cervical, supraclavicular, axillary\nor inguinal areas_\nGenital/Rectal:\nNormal rectal sphincter tone;\nno rectal masses or\nAlways include these exams, or comment specifically\ntenderness_\nStool is brown and guaiac negative.\nPelvic\nwhy\nwere omitted\nMore\nthey\nexmaination reveals normal external genitalia, and normal\nvagina and cervix on speculum examination.\nBimanual\nexamination reveals no palpable uterus, ovaries, or masses_\nNeurological:\nCranial nerves II-XII are normal_\nMotor and sensory\nexamination of the upper and lower extremities is normal:\nGait and cerebellar function are also normal_\nReflexes are\nnormal and symmetrical bilaterally in both extremities.\nInitial Problem List\nChest Pain\nAlthough you can omit this initial problem list from your\n2.\nDyspnea\nfinal written H&P , (and just list a final problem list\n3_\nHistory of HTN (4 years)\nshown below), it is useful to make an initial list simply\n4 .\nHistory of TAHIBSO\nto keep track of all problems uncovered in the interview\n5.\nHistory of peptic ulcer disease\n(#1-9 in this list) and exam (#10-13)\n6,\nPenicillin allergy\nFH of early ASCVD\n8.\nEpigastric pain\n9.\nLow back pain\n10.\nHypertension\n11.\nSystolic murmur\n12.\nCystic changes of breasts\n13_\nAbdominal bruit\nRevised Problem List\nChest pain\nThis list regroups related problems (or those you\n2_\nFH of early ASCVD\nsuspect are related) into\na more\nlogical sequence\n3_\nEarly surgical menopause\n4.\nDyspnea\n5.\nRecent onset HTN\n6.\nAbdominal bruit\n7 .\nSystolic ejection murmur\n8.\nEpigastric pain\n9.\nHistory of peptic ulcer disease\n10.\nLumbosacral back pain\n11.\nOTC non-steroidal analgesic use\n12.\nCystic changes of breasts\n13_\nPenicillin allergy\nAssessment and Differential Diagnosis\nChest pain with features of angina pectoris\nThis patient\'s description of dull, aching, exertion\nrelated substernal chest pain is suggestive of ischemic cardiac\norigin:\nHer findings of a FH of early ASCVD, hypertension, and\nIn the assessment you take each of the patients major\nearly surgical menopause are pertinent risk factors for development\nproblems and draw conclusions, in this case that the chest\nof coronary artery disease_\nTherefore, the combination of this\npain is more likely due to ischemic heart disease instead\npatient\'s presentation, and the multiple risk factors make angina\nof other possibilities_\nYou tie in several of the other\npectoris the most likely diagnosis\nThe pain symptoms appear to\nproblems as risk factors for ischemic heart disease, and\nbe increasing, and the occurrence of pain at rest suggests this\nnot merely as random unrelated problems_\nYou should list\nfits the presentation of unstable angina, and hospitalization is\nand extensive justification for your most likely diagnosis_\nindicated.\nYou should also explain why\nare less suspicious of\nalternative diagnoses, such as esophageal reflux disease,\nOther processes may explain her chest pain, but\npulmonary or musculoskeletal pain:\nare less likely.   Gastro-esophageal reflux disease (GERD) may\noccur at night with recumbency, but usually is not associated with\nexertion.\nThe pain of GERD is usually burning; and the patient\ndescribes no associated gastrointestinal symptoms such as\nnausea,\nvomiting or abdominal pain which might suggest peptic\nulcer disease_\nThe presence of dyspnea might suggest a\npulmonary component to this patients disease process, but\nthe absence of fever, cough or abnormal pulmonary examination\nfindings make\npulmonary infection less likely, and the\nassociation of the dyspnea with the chest pain supports the\ntheory that both symptoms may be from ischemic heart disease_\n2_\nDyspnea\nHer dyspnea may correlate with findings on physical\nexam of a third heart sound and pulmonary crackles,\nsuggesting left ventricular dysfunction_\nIn that case, she may\nAs in the previous problem; you should explain, in more\nbe manifesting symptoms and findings of congestive heart\ndetail than is shown in this example; why you felt the dyspnea\nfailure from myocardial ischemia.\nis more likely to be from ischemic heart disease, and not\nasthma, bronchitis, or other possibilities_\nFollow this pattern\n3.\nRecent onset hypertension and abdominal bruit\nfor all subsequent problems:\nThis combination raises the possibility of a\nsecondary cause of hypertension, specifically ASCVD of the\nrenal artery leading to renovascular hypertension:\nThe lack\nof hypertensive retinopathy and left ventricular hypertrophy\non\nphysical examination further support a recent onset of her\nBP elevation:\n4_\nSystolic murmur\nThe possibility of important valvular heart disease\nis raised by the murmur; specifically, aortic stenosis_\nThe\nmurmur radiates to the neck as an aortic valvular murmur\noften does, but a normal carotid upstroke\nmean this\nmurmur is not significant:\n5_\nEpigastric discomfort; NSAID use with a history\nof peptic ulcer disease_\n6_\nLumbo-sacral back pain\n7 .\nFibrocystic breast disease\n8_\nPenicillin\nallergy\nyou\nmay\nPlan:\nCarefully monitor the patient for any increased chest pain that\nYou should develop a diagnostic and therapeutic plan\nmight be indicative of impending myocardial infarction by admitting\nfor the patient.\nYour plan should incorporate acute and\nthe patient to the telemetry floor:\nlong-term care of the patient\'s most likely problem:\nshould consider pharmacologic and non-pharmacologic\n2_\nStart platelet inhibitors, such as aspirin to decrease the risk of\nmeasures and be cognizant of the fact that you need to\nmyocardial infarction; start nitrates to decrease the risk of occlusion\ntreat the symptoms (i.e_\nmake the patient comfortable) as\nand to treat her symptoms of pain.\nFor prolonged\nun-\nmuch as\ntreating the disease when possible.\nYou are\nresponsive to nitrates, she may need an analgesic such as\nexpected to know the usual classes of medications used\nmorphine.\nThe nitrates will also help to lower her BP_\nto treat these illnesses_\n3_\nPatient should have her cholesterol monitored and when\ndischarged she should be started on an appropriate exercise and\nweight loss program, including a low-fat diet:\nIf her cholesterol\nis elevated; she may need cholesterol-lowering medication such\nas HMG Co-reductases\nSchedule a cardiac catheterization since non-invasive\ntests have\nhigh pretest probability for being positive and regard-\nless of the result; negative or positive, she will need\na cath\n5_\nBegin diuretics for her dyspnea which is most likely secondary\nto volume overload\nthis will treat her high BP as well:\nShe should\nhave\nventriculogram with the cath that will assess cardiac size\nand presence of wall motion abnormalities.\n6_\nAppropriate lab work would include BUNICreatinine\nto assess\nkidney function, electrolytes and baseline EKG.\nYou\npain",
    "confidence": 0.8543846785146648
    }
    agent = create_document_agent()
    file_path = "./sample-report.pdf"
    prompt = f"""
    You are a document saving agent.
    You will pass the text to the StoreContent tool and it will return some metadata, you will only return the metadata
    text = {text}
        """

    response = agent.invoke({
        "input": prompt
    })
    print("\n=== DOCUMENT SAVE RESULT ===")
    print(response)